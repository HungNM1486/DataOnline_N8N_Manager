#!/bin/bash

# DataOnline N8N Manager - Database Manager Plugin  
# Phi√™n b·∫£n: 1.0.0
# M√¥ t·∫£: NocoDB integration cho qu·∫£n l√Ω database N8N

set -euo pipefail

# Source core modules
PLUGIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PLUGIN_PROJECT_ROOT="$(dirname "$(dirname "$PLUGIN_DIR")")"

# Load core modules if not loaded
[[ -z "${LOGGER_LOADED:-}" ]] && source "$PLUGIN_PROJECT_ROOT/src/core/logger.sh"
[[ -z "${CONFIG_LOADED:-}" ]] && source "$PLUGIN_PROJECT_ROOT/src/core/config.sh"
[[ -z "${UTILS_LOADED:-}" ]] && source "$PLUGIN_PROJECT_ROOT/src/core/utils.sh"
[[ -z "${UI_LOADED:-}" ]] && source "$PLUGIN_PROJECT_ROOT/src/core/ui.sh"
[[ -z "${SPINNER_LOADED:-}" ]] && source "$PLUGIN_PROJECT_ROOT/src/core/spinner.sh"

# Load sub-modules
source "$PLUGIN_DIR/nocodb-setup.sh"
source "$PLUGIN_DIR/nocodb-management.sh"

# Constants
readonly DATABASE_MANAGER_LOADED=true
readonly NOCODB_PORT=8080
readonly NOCODB_CONTAINER="n8n-nocodb"
readonly N8N_COMPOSE_DIR="/opt/n8n"

# ===== MAIN MENU FUNCTION =====

database_manager_main() {
    ui_header "Qu·∫£n l√Ω Database N8N v·ªõi NocoDB"

    while true; do
        show_database_manager_menu
        
        echo -n -e "${UI_WHITE}Ch·ªçn [0-8]: ${UI_NC}"
        read -r choice

        case "$choice" in
        1) check_nocodb_status ;;
        2) install_nocodb ;;
        3) open_nocodb_interface ;;
        4) setup_nocodb_ssl ;; 
        5) uninstall_nocodb ;;
        0) return 0 ;;
        *) ui_status "error" "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá" ;;
        esac

        echo ""
        read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."
    done
}

# ===== MENU DISPLAY =====

show_database_manager_menu() {
    local nocodb_status=$(get_nocodb_status)
    local nocodb_url=$(get_nocodb_url)
    
    echo ""
    ui_section "Tr·∫°ng th√°i NocoDB"
    echo "Status: $nocodb_status"
    if [[ -n "$nocodb_url" ]]; then
        echo "URL: $nocodb_url"
    fi
    echo ""
    
    echo "üóÑÔ∏è  QU·∫¢N L√ù DATABASE N8N"
    echo ""
    echo "1) üìä Ki·ªÉm tra tr·∫°ng th√°i"
    echo "2) üöÄ C√†i ƒë·∫∑t NocoDB"
    echo "3) üåê M·ªü giao di·ªán NocoDB"
    echo "4) üîí C√†i ƒë·∫∑t SSL"
    echo "5) üóëÔ∏è  G·ª° c√†i ƒë·∫∑t NocoDB"
    echo "0) ‚¨ÖÔ∏è  Quay l·∫°i"
    echo ""
}

# ===== STATUS FUNCTIONS =====

get_nocodb_status() {
    if docker ps --format '{{.Names}}' | grep -q "^${NOCODB_CONTAINER}$"; then
        if curl -s "http://localhost:${NOCODB_PORT}/api/v1/health" >/dev/null 2>&1; then
            echo -e "${UI_GREEN}üü¢ Ho·∫°t ƒë·ªông${UI_NC}"
        else
            echo -e "${UI_YELLOW}üü° Kh·ªüi ƒë·ªông${UI_NC}"
        fi
    else
        echo -e "${UI_RED}üî¥ Ch∆∞a c√†i ƒë·∫∑t${UI_NC}"
    fi
}

get_nocodb_url() {
    local domain=$(config_get "nocodb.domain" "")
    
    # Ch·ªâ hi·ªÉn th·ªã n·∫øu ƒë√£ th·ª±c s·ª± c·∫•u h√¨nh
    if [[ -n "$domain" ]]; then
        echo "https://$domain"
    else
        # Kh√¥ng t·ª± ƒë·ªông t·∫°o subdomain, return empty
        echo ""
    fi
}

check_nocodb_status() {
    ui_section "Ki·ªÉm tra tr·∫°ng th√°i NocoDB chi ti·∫øt"
    
    # Check container
    if docker ps --format '{{.Names}}' | grep -q "^${NOCODB_CONTAINER}$"; then
        ui_status "success" "Container NocoDB ƒëang ch·∫°y"
        
        # Get container info
        local container_id=$(docker ps -q --filter "name=^${NOCODB_CONTAINER}$")
        if [[ -n "$container_id" ]]; then
            echo "Container ID: $container_id"
            echo "Image: $(docker inspect $container_id --format '{{.Config.Image}}')"
            echo "Started: $(docker inspect $container_id --format '{{.State.StartedAt}}' | cut -d'T' -f1)"
            echo "Status: $(docker inspect $container_id --format '{{.State.Status}}')"
        fi
    else
        ui_status "error" "Container NocoDB kh√¥ng ch·∫°y"
    fi
    
    # Check API health
    echo ""
    ui_start_spinner "Ki·ªÉm tra API health"
    if curl -s "http://localhost:${NOCODB_PORT}/api/v1/health" >/dev/null 2>&1; then
        ui_stop_spinner
        ui_status "success" "NocoDB API ph·∫£n h·ªìi"
    else
        ui_stop_spinner
        ui_status "error" "NocoDB API kh√¥ng ph·∫£n h·ªìi"
    fi
    
    # Check database connection
    echo ""
    ui_start_spinner "Ki·ªÉm tra k·∫øt n·ªëi database"
    if test_nocodb_database_connection; then
        ui_stop_spinner
        ui_status "success" "K·∫øt n·ªëi database OK"
    else
        ui_stop_spinner
        ui_status "error" "K·∫øt n·ªëi database th·∫•t b·∫°i"
    fi
    
    # Show URLs
    echo ""
    ui_info_box "Th√¥ng tin truy c·∫≠p" \
        "URL: $(get_nocodb_url)" \
        "Port: $NOCODB_PORT" \
        "Admin: $(config_get "nocodb.admin_email" "admin@localhost")"
}

test_nocodb_database_connection() {
    # Test connection through NocoDB API
    local response=$(curl -s "http://localhost:${NOCODB_PORT}/api/v1/db/meta/projects" 2>/dev/null || echo "")
    [[ -n "$response" ]]
}

# ===== QUICK INTERFACE ACCESS =====

open_nocodb_interface() {
    ui_section "Truy c·∫≠p giao di·ªán NocoDB"
    
    local nocodb_url=$(get_nocodb_url)
    local nocodb_status=$(get_nocodb_status)
    
    if [[ "$nocodb_status" == *"üî¥"* ]]; then
        ui_status "error" "NocoDB ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t ho·∫∑c kh√¥ng ho·∫°t ƒë·ªông"
        echo -n -e "${UI_YELLOW}B·∫°n c√≥ mu·ªën c√†i ƒë·∫∑t NocoDB ngay? [Y/n]: ${UI_NC}"
        read -r install_now
        if [[ ! "$install_now" =~ ^[Nn]$ ]]; then
            install_nocodb
        fi
        return
    fi
    
    ui_info_box "Th√¥ng tin ƒëƒÉng nh·∫≠p NocoDB" \
        "üåê URL: $nocodb_url" \
        "üë§ Email: $(config_get "nocodb.admin_email" "admin@localhost")" \
        "üîë Password: $(get_nocodb_admin_password)" \
        "" \
        "üí° Tip: Bookmark URL n√†y ƒë·ªÉ truy c·∫≠p nhanh"
    
    # Show N8N database connection info
    local n8n_postgres_password=$(grep "POSTGRES_PASSWORD=" "$N8N_COMPOSE_DIR/.env" | cut -d'=' -f2 2>/dev/null || echo "N/A")
    ui_info_box "K·∫øt n·ªëi N8N Database trong NocoDB" \
        "Host: postgres (ho·∫∑c IP server)" \
        "Port: 5432" \
        "Database: n8n" \
        "User: n8n" \
        "Password: $n8n_postgres_password" \
        "" \
        "üí° S·ª≠ d·ª•ng th√¥ng tin n√†y ƒë·ªÉ k·∫øt n·ªëi N8N data trong NocoDB"
    
    # Try to open in browser if possible
    if command_exists xdg-open; then
        echo -n -e "${UI_YELLOW}M·ªü trong browser? [Y/n]: ${UI_NC}"
        read -r open_browser
        if [[ ! "$open_browser" =~ ^[Nn]$ ]]; then
            xdg-open "$nocodb_url" 2>/dev/null &
            ui_status "success" "ƒê√£ m·ªü browser"
        fi
    elif command_exists open; then  # macOS
        echo -n -e "${UI_YELLOW}M·ªü trong browser? [Y/n]: ${UI_NC}"
        read -r open_browser
        if [[ ! "$open_browser" =~ ^[Nn]$ ]]; then
            open "$nocodb_url" 2>/dev/null &
            ui_status "success" "ƒê√£ m·ªü browser"
        fi
    fi
}

get_nocodb_admin_password() {
    local password_file="$N8N_COMPOSE_DIR/.nocodb-admin-password"
    if [[ -f "$password_file" ]]; then
        cat "$password_file"
    else
        echo "Xem trong file .env: NOCODB_ADMIN_PASSWORD"
    fi
}

# ===== INSTALLATION ENTRY POINT =====

install_nocodb() {
    ui_header "C√†i ƒë·∫∑t NocoDB Database Manager"
    
    # Check prerequisites
    if ! check_nocodb_prerequisites; then
        ui_status "error" "Y√™u c·∫ßu h·ªá th·ªëng ch∆∞a ƒë√°p ·ª©ng"
        return 1
    fi
    
    # Confirm installation
    ui_warning_box "X√°c nh·∫≠n c√†i ƒë·∫∑t" \
        "S·∫Ω th√™m NocoDB v√†o N8N stack hi·ªán t·∫°i" \
        "Port s·ª≠ d·ª•ng: $NOCODB_PORT" \
        "D·ªØ li·ªáu s·∫Ω k·∫øt n·ªëi v·ªõi PostgreSQL N8N"
    
    if ! ui_confirm "Ti·∫øp t·ª•c c√†i ƒë·∫∑t NocoDB?"; then
        return 0
    fi
    
    # Run installation
    if setup_nocodb_integration; then
        ui_status "success" "üéâ NocoDB ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t th√†nh c√¥ng!"
        
        ui_info_box "B∆∞·ªõc ti·∫øp theo" \
            "1. Truy c·∫≠p giao di·ªán (option 3)" \
            "2. T·∫°o connection t·ªõi N8N database" \
            "3. T·∫°o views v√† dashboards theo nhu c·∫ßu"
    else
        ui_status "error" "C√†i ƒë·∫∑t NocoDB th·∫•t b·∫°i"
        return 1
    fi
}

check_nocodb_prerequisites() {
    ui_section "Ki·ªÉm tra y√™u c·∫ßu h·ªá th·ªëng"
    
    local errors=0
    
    # Check N8N installation
    if [[ ! -f "$N8N_COMPOSE_DIR/docker-compose.yml" ]]; then
        ui_status "error" "N8N ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t"
        ((errors++))
    else
        ui_status "success" "N8N ƒë√£ c√†i ƒë·∫∑t"
    fi
    
    # Check Docker
    if ! command_exists docker; then
        ui_status "error" "Docker ch∆∞a c√†i ƒë·∫∑t"
        ((errors++))
    else
        ui_status "success" "Docker available"
    fi
    
    # Check port availability
    if ! is_port_available $NOCODB_PORT; then
        ui_status "error" "Port $NOCODB_PORT ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng"
        ((errors++))
    else
        ui_status "success" "Port $NOCODB_PORT available"
    fi
    
    # Check PostgreSQL
    if ! docker ps --format '{{.Names}}' | grep -q "postgres"; then
        ui_status "error" "PostgreSQL container kh√¥ng ch·∫°y"
        ((errors++))
    else
        ui_status "success" "PostgreSQL container OK"
    fi
    
    # Check disk space (minimum 1GB)
    local free_space_gb=$(df -BG "$N8N_COMPOSE_DIR" | awk 'NR==2 {print $4}' | sed 's/G//')
    if [[ "$free_space_gb" -lt 1 ]]; then
        ui_status "error" "C·∫ßn √≠t nh·∫•t 1GB dung l∆∞·ª£ng tr·ªëng"
        ((errors++))
    else
        ui_status "success" "Dung l∆∞·ª£ng: ${free_space_gb}GB"
    fi
    
    return $errors
}

# ===== SSL SETUP FUNCTION =====

setup_nocodb_ssl() {
    ui_section "C√†i ƒë·∫∑t SSL cho NocoDB"
    
    local nocodb_domain=""
    local main_domain=$(config_get "n8n.domain" "")
    
    echo "üìã **Domain Options:**"
    echo ""
    if [[ -n "$main_domain" ]]; then
        echo "1) S·ª≠ d·ª•ng subdomain: db.$main_domain"
        echo "2) Nh·∫≠p domain kh√°c"
    else
        echo "1) Nh·∫≠p domain m·ªõi"
    fi
    echo ""
    
    while true; do
        if [[ -n "$main_domain" ]]; then
            read -p "Ch·ªçn [1-2]: " domain_choice
            case "$domain_choice" in
            1) 
                nocodb_domain="db.$main_domain"
                break
                ;;
            2)
                echo -n -e "${UI_WHITE}Nh·∫≠p domain cho NocoDB: ${UI_NC}"
                read -r nocodb_domain
                if [[ -n "$nocodb_domain" ]]; then
                    break
                else
                    ui_status "error" "Domain kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng"
                fi
                ;;
            *)
                ui_status "error" "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá"
                ;;
            esac
        else
            echo -n -e "${UI_WHITE}Nh·∫≠p domain cho NocoDB: ${UI_NC}"
            read -r nocodb_domain
            if [[ -n "$nocodb_domain" ]]; then
                break
            else
                ui_status "error" "Domain kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng"
            fi
        fi
    done
    
    # Validate domain format
    if ! ui_validate_domain "$nocodb_domain"; then
        ui_status "error" "Domain format kh√¥ng h·ª£p l·ªá: $nocodb_domain"
        return 1
    fi
    
    # Check DNS resolution
    echo ""
    ui_start_spinner "Ki·ªÉm tra DNS cho $nocodb_domain"
    local server_ip=$(get_public_ip)
    local resolved_ip=$(dig +short A "$nocodb_domain" @1.1.1.1 | tail -n1)
    ui_stop_spinner
    
    if [[ -z "$resolved_ip" ]]; then
        ui_status "error" "Domain kh√¥ng th·ªÉ resolve: $nocodb_domain"
        echo -n -e "${UI_YELLOW}Ti·∫øp t·ª•c d√π DNS ch∆∞a setup? [y/N]: ${UI_NC}"
        read -r skip_dns
        if [[ ! "$skip_dns" =~ ^[Yy]$ ]]; then
            return 1
        fi
    elif [[ "$resolved_ip" != "$server_ip" ]]; then
        ui_status "warning" "DNS tr·ªè v·ªÅ $resolved_ip (server: $server_ip)"
        echo -n -e "${UI_YELLOW}Ti·∫øp t·ª•c d√π DNS kh√¥ng ƒë√∫ng? [y/N]: ${UI_NC}"
        read -r skip_dns
        if [[ ! "$skip_dns" =~ ^[Yy]$ ]]; then
            return 1
        fi
    else
        ui_status "success" "DNS OK: $nocodb_domain ‚Üí $server_ip"
    fi
    
    # Final confirmation
    ui_info_box "SSL Setup Confirmation" \
        "Domain: $nocodb_domain" \
        "Server IP: $server_ip" \
        "Port: 8080 ‚Üí 443" \
        "Certificate: Let's Encrypt"
    
    if ! ui_confirm "X√°c nh·∫≠n setup SSL cho $nocodb_domain?"; then
        return 0
    fi
    
    # Save domain to config
    config_set "nocodb.domain" "$nocodb_domain"
    
    # SSL setup implementation
    create_nocodb_nginx_config "$nocodb_domain" || return 1
    obtain_nocodb_ssl_certificate "$nocodb_domain" || return 1
    upgrade_to_https_config "$nocodb_domain" || return 1
    update_nocodb_ssl_config "$nocodb_domain" || return 1
    
    ui_status "success" "SSL setup ho√†n t·∫•t cho $nocodb_domain"
}

create_nocodb_nginx_config() {
    local domain="$1"
    local nginx_conf="/etc/nginx/sites-available/${domain}.conf"
    
    ui_start_spinner "T·∫°o HTTP config cho $domain"
    
    # Create HTTP-only config first
    sudo tee "$nginx_conf" > /dev/null << EOF
server {
    listen 80;
    server_name $domain;

    location /.well-known/acme-challenge/ {
        root /var/www/html;
        allow all;
    }

    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF

    sudo ln -sf "$nginx_conf" /etc/nginx/sites-enabled/
    sudo nginx -t && sudo systemctl reload nginx
    ui_stop_spinner
    ui_status "success" "HTTP config t·∫°o th√†nh c√¥ng"
}

upgrade_to_https_config() {
    local domain="$1"
    local nginx_conf="/etc/nginx/sites-available/${domain}.conf"
    
    ui_start_spinner "N√¢ng c·∫•p l√™n HTTPS"
    
    sudo tee "$nginx_conf" > /dev/null << EOF
server {
    listen 80;
    server_name $domain;
    return 301 https://\$host\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name $domain;

    ssl_certificate /etc/letsencrypt/live/$domain/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$domain/privkey.pem;
    
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF

    sudo nginx -t && sudo systemctl reload nginx
    ui_stop_spinner
    ui_status "success" "HTTPS config ho·∫°t ƒë·ªông"
}

obtain_nocodb_ssl_certificate() {
    local subdomain="$1"
    local email="admin@$(config_get "n8n.domain")"
    
    # Ensure webroot exists
    sudo mkdir -p /var/www/html/.well-known/acme-challenge
    sudo chown -R www-data:www-data /var/www/html
    
    # Test nginx config
    if ! sudo nginx -t; then
        ui_status "error" "Nginx config c√≥ l·ªói"
        return 1
    fi
    
    # Reload nginx
    sudo systemctl reload nginx
    
    ui_start_spinner "L·∫•y SSL certificate cho $subdomain"
    
    if sudo certbot certonly --webroot \
        -w /var/www/html \
        -d "$subdomain" \
        --agree-tos \
        --email "$email" \
        --non-interactive; then
        ui_stop_spinner
        ui_status "success" "SSL certificate th√†nh c√¥ng"
    else
        ui_stop_spinner
        ui_status "error" "SSL certificate th·∫•t b·∫°i"
        return 1
    fi
    
    # Reload nginx with SSL
    sudo systemctl reload nginx
}

update_nocodb_ssl_config() {
    local subdomain="$1"
    
    ui_start_spinner "C·∫≠p nh·∫≠t NocoDB config"
    
    # Update .env
    sed -i "s|NOCODB_PUBLIC_URL=.*|NOCODB_PUBLIC_URL=https://$subdomain|" "$N8N_COMPOSE_DIR/.env"
    
    # Save to manager config
    config_set "nocodb.domain" "$subdomain"
    config_set "nocodb.ssl_enabled" "true"
    
    # Restart NocoDB
    cd "$N8N_COMPOSE_DIR"
    docker compose restart nocodb
    
    ui_stop_spinner
    ui_status "success" "NocoDB config c·∫≠p nh·∫≠t th√†nh c√¥ng"
}

# ===== UNINSTALL FUNCTION =====

uninstall_nocodb() {
    ui_section "G·ª° c√†i ƒë·∫∑t NocoDB"
    
    ui_warning_box "‚ö†Ô∏è  C·∫¢NH B√ÅO" \
        "S·∫Ω x√≥a ho√†n to√†n NocoDB v√† c·∫•u h√¨nh" \
        "D·ªØ li·ªáu N8N s·∫Ω kh√¥ng b·ªã ·∫£nh h∆∞·ªüng" \
        "Views v√† dashboard s·∫Ω b·ªã m·∫•t"
    
    if ! ui_confirm "B·∫°n ch·∫Øc ch·∫Øn mu·ªën g·ª° NocoDB?"; then
        return 0
    fi
    
    # Backup tr∆∞·ªõc khi x√≥a
    echo -n -e "${UI_YELLOW}Backup c·∫•u h√¨nh tr∆∞·ªõc khi x√≥a? [Y/n]: ${UI_NC}"
    read -r backup_first
    if [[ ! "$backup_first" =~ ^[Nn]$ ]]; then
        backup_nocodb_config
    fi
    
    # Remove NocoDB
    if remove_nocodb_integration; then
        ui_status "success" "NocoDB ƒë√£ ƒë∆∞·ª£c g·ª° b·ªè ho√†n to√†n"
    else
        ui_status "error" "G·ª° b·ªè NocoDB th·∫•t b·∫°i"
        return 1
    fi
}

# Export main function
export -f database_manager_main