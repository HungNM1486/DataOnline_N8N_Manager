#!/bin/bash

# DataOnline N8N Manager - NocoDB N8N Data Manager
# Phi√™n b·∫£n: 2.0.0

set -euo pipefail

PLUGIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PLUGIN_PROJECT_ROOT="$(dirname "$(dirname "$PLUGIN_DIR")")"

[[ -z "${LOGGER_LOADED:-}" ]] && source "$PLUGIN_PROJECT_ROOT/src/core/logger.sh"
[[ -z "${CONFIG_LOADED:-}" ]] && source "$PLUGIN_PROJECT_ROOT/src/core/config.sh"
[[ -z "${UTILS_LOADED:-}" ]] && source "$PLUGIN_PROJECT_ROOT/src/core/utils.sh"
[[ -z "${UI_LOADED:-}" ]] && source "$PLUGIN_PROJECT_ROOT/src/core/ui.sh"
[[ -z "${SPINNER_LOADED:-}" ]] && source "$PLUGIN_PROJECT_ROOT/src/core/spinner.sh"

readonly NOCODB_LOADED=true
readonly NOCODB_DIR="/opt/nocodb"
readonly DEFAULT_PORT="8080"
readonly BACKUP_DIR="/opt/n8n/backups/nocodb"

# ===== CORE FUNCTIONS =====

nocodb_main_menu() {
    while true; do
        ui_header "NocoDB - N8N Data Manager"

        if is_nocodb_installed; then
            show_management_menu
        else
            show_install_menu
        fi

        echo ""
        read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."
    done
}

is_nocodb_installed() {
    [[ -f "$NOCODB_DIR/docker-compose.yml" ]]
}

show_install_menu() {
    echo "üöÄ C√†i ƒë·∫∑t NocoDB cho N8N"
    echo ""
    echo "1) üìä C√†i ƒë·∫∑t v·ªõi quy·ªÅn ƒë·∫ßy ƒë·ªß (cho admin)"
    echo "2) üëÅÔ∏è  C√†i ƒë·∫∑t ch·∫ø ƒë·ªô ch·ªâ xem (an to√†n)"
    echo "0) ‚ùå Quay l·∫°i"
    echo ""

    echo -n -e "${UI_WHITE}Ch·ªçn [0-2]: ${UI_NC}"
    read -r choice

    case "$choice" in
    1) install_nocodb_full_access ;;
    2) install_nocodb_readonly ;;
    0) return ;;
    *) ui_status "error" "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá" ;;
    esac
}

show_management_menu() {
    local status=$(get_nocodb_status)
    echo "Tr·∫°ng th√°i: $status"
    echo ""
    echo "1) üåê Th√¥ng tin truy c·∫≠p"
    echo "2) üë• Qu·∫£n l√Ω quy·ªÅn truy c·∫≠p"
    echo "3) üìö H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng N8N tables"
    echo "4) üíæ Backup data tr∆∞·ªõc khi s·ª≠a"
    echo "5) üîÑ Restart service"
    echo "6) üìù Xem logs"
    echo "7) üóëÔ∏è  G·ª° c√†i ƒë·∫∑t"
    echo "0) ‚ùå Quay l·∫°i"
    echo ""

    echo -n -e "${UI_WHITE}Ch·ªçn [0-7]: ${UI_NC}"
    read -r choice

    case "$choice" in
    1) show_access_info ;;
    2) manage_access_permissions ;;
    3) show_n8n_tables_guide ;;
    4) backup_n8n_data ;;
    5) restart_nocodb ;;
    6) show_logs ;;
    7) uninstall_nocodb ;;
    0) return ;;
    *) ui_status "error" "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá" ;;
    esac
}

# ===== VALIDATION FUNCTIONS =====

validate_domain() {
    local domain="$1"
    if [[ ! "$domain" =~ ^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*$ ]]; then
        ui_status "error" "Domain format kh√¥ng h·ª£p l·ªá"
        return 1
    fi
    return 0
}

validate_port() {
    local port="$1"
    if [[ ! "$port" =~ ^[0-9]+$ ]] || [[ "$port" -lt 1024 ]] || [[ "$port" -gt 65535 ]]; then
        ui_status "error" "Port kh√¥ng h·ª£p l·ªá (1024-65535)"
        return 1
    fi
    if ! is_port_available "$port"; then
        ui_status "error" "Port $port ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng"
        return 1
    fi
    return 0
}

# ===== INSTALLATION FUNCTIONS =====

install_nocodb_full_access() {
    ui_section "C√†i ƒë·∫∑t NocoDB v·ªõi quy·ªÅn ƒë·∫ßy ƒë·ªß"

    ui_warning_box "‚ö†Ô∏è C·∫¢NH B√ÅO" \
        "Ch·∫ø ƒë·ªô n√†y cho ph√©p CH·ªàNH S·ª¨A data N8N" \
        "Ch·ªâ d√†nh cho admin c√≥ kinh nghi·ªám" \
        "Sai thao t√°c c√≥ th·ªÉ l√†m h·ªèng N8N!"

    if ! ui_confirm "B·∫°n ch·∫Øc ch·∫Øn mu·ªën c√†i ƒë·∫∑t v·ªõi quy·ªÅn ƒë·∫ßy ƒë·ªß?"; then
        return
    fi

    config_set "nocodb.access_mode" "full"
    install_nocodb_with_n8n_db
}

install_nocodb_readonly() {
    ui_section "C√†i ƒë·∫∑t NocoDB ch·∫ø ƒë·ªô ch·ªâ xem"

    ui_info_box "‚ÑπÔ∏è Ch·∫ø ƒë·ªô an to√†n" \
        "Ch·ªâ c√≥ th·ªÉ XEM data, kh√¥ng th·ªÉ s·ª≠a" \
        "Ph√π h·ª£p cho monitoring v√† b√°o c√°o"

    config_set "nocodb.access_mode" "readonly"
    install_nocodb_with_n8n_db
}

install_nocodb_with_n8n_db() {
    # Check N8N installation
    if [[ ! -f "/opt/n8n/docker-compose.yml" ]]; then
        ui_status "error" "N8N ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t"
        return 1
    fi

    # Get configuration
    local domain port

    echo -n -e "${UI_WHITE}Nh·∫≠p domain cho NocoDB: ${UI_NC}"
    read -r domain
    if ! validate_domain "$domain"; then
        return 1
    fi

    echo -n -e "${UI_WHITE}Port NocoDB ($DEFAULT_PORT): ${UI_NC}"
    read -r port
    port=${port:-$DEFAULT_PORT}
    if ! validate_port "$port"; then
        return 1
    fi

    # Check prerequisites
    if ! check_prerequisites; then
        return 1
    fi

    # Save config
    config_set "nocodb.domain" "$domain"
    config_set "nocodb.port" "$port"

    # Install
    if ! install_nocodb_components; then
        ui_status "error" "C√†i ƒë·∫∑t th·∫•t b·∫°i"
        cleanup_failed_installation
        return 1
    fi

    ui_status "success" "NocoDB c√†i ƒë·∫∑t th√†nh c√¥ng!"
    show_access_info
}

check_prerequisites() {
    ui_start_spinner "Ki·ªÉm tra y√™u c·∫ßu"

    local errors=0

    # Check Docker
    if ! command_exists docker; then
        ui_status "error" "Docker ch∆∞a c√†i ƒë·∫∑t"
        ((errors++))
    fi

    # Check disk space
    local free_gb=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
    if [[ "$free_gb" -lt 2 ]]; then
        ui_status "error" "C·∫ßn √≠t nh·∫•t 2GB dung l∆∞·ª£ng (hi·ªán c√≥: ${free_gb}GB)"
        ((errors++))
    fi

    ui_stop_spinner
    
    # Deep cleanup old installations
    cleanup_old_nocodb_installations

    return $errors
}

cleanup_old_nocodb_installations() {
    ui_start_spinner "D·ªçn d·∫πp c√†i ƒë·∫∑t c≈©..."

    # Stop and remove all NocoDB related containers
    local containers=$(docker ps -a --format '{{.Names}}' | grep -E "nocodb|nocodb-postgres" || true)
    if [[ -n "$containers" ]]; then
        ui_status "info" "D·ª´ng containers c≈©..."
        echo "$containers" | xargs -r docker rm -f 2>/dev/null || true
    fi

    # Remove all NocoDB volumes
    local volumes=$(docker volume ls --format '{{.Name}}' | grep -E "nocodb" || true)
    if [[ -n "$volumes" ]]; then
        ui_status "info" "X√≥a volumes c≈©..."
        echo "$volumes" | xargs -r docker volume rm 2>/dev/null || true
    fi

    # Remove old directories
    local old_dirs=("/nocodb-cloud" "/opt/nocodb-db" "$NOCODB_DIR")
    for dir in "${old_dirs[@]}"; do
        if [[ -d "$dir" ]]; then
            ui_status "info" "X√≥a th∆∞ m·ª•c: $dir"
            rm -rf "$dir" 2>/dev/null || true
        fi
    done

    # Clean database users
    if docker ps --format '{{.Names}}' | grep -q "n8n-postgres"; then
        ui_status "info" "D·ªçn d·∫πp database users..."
        docker exec n8n-postgres psql -U n8n -d n8n -c "
            DROP USER IF EXISTS nocodb_readonly;
            DROP USER IF EXISTS nocodb_full;
        " 2>/dev/null || true
    fi

    # Clean all nginx configs
    cleanup_nginx_configs

    # Remove htpasswd files
    rm -f /etc/nginx/.htpasswd-nocodb* 2>/dev/null || true

    ui_stop_spinner
    ui_status "success" "D·ªçn d·∫πp ho√†n t·∫•t"
}

cleanup_nginx_configs() {
    local cleaned=0
    
    for nginx_conf in /etc/nginx/sites-available/*.conf; do
        if [[ -f "$nginx_conf" ]] && grep -q "location /nocodb" "$nginx_conf" 2>/dev/null; then
            ui_status "info" "D·ªçn d·∫πp NocoDB config trong: $(basename "$nginx_conf")"
            
            # Backup first
            cp "$nginx_conf" "${nginx_conf}.pre-nocodb-cleanup.$(date +%Y%m%d_%H%M%S)"
            
            # Remove nocodb location block
            sed -i '/# NocoDB subdirectory/,/^$/d' "$nginx_conf" 2>/dev/null || true
            
            ((cleaned++))
        fi
    done
    
    if [[ $cleaned -gt 0 ]]; then
        systemctl reload nginx 2>/dev/null || true
    fi
}

install_nocodb_components() {
    create_directories || return 1
    collect_credentials || return 1
    setup_database_access || return 1
    create_docker_config || return 1
    create_basic_auth || return 1
    configure_nginx || return 1
    start_services || return 1
    return 0
}

# ===== DATABASE ACCESS SETUP =====

setup_database_access() {
    ui_start_spinner "C·∫•u h√¨nh truy c·∫≠p database"

    local access_mode=$(config_get "nocodb.access_mode")
    local n8n_db_password

    # Check if n8n-postgres is running
    if ! docker ps --format '{{.Names}}' | grep -q "n8n-postgres"; then
        ui_stop_spinner
        ui_status "error" "PostgreSQL container kh√¥ng ch·∫°y"
        ui_status "info" "ƒêang kh·ªüi ƒë·ªông PostgreSQL..."
        
        cd /opt/n8n && docker compose up -d postgres
        sleep 5
        
        if ! docker ps --format '{{.Names}}' | grep -q "n8n-postgres"; then
            ui_status "error" "Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông PostgreSQL"
            return 1
        fi
    fi

    # Get N8N database password
    if [[ -f "/opt/n8n/.env" ]]; then
        n8n_db_password=$(grep "POSTGRES_PASSWORD=" /opt/n8n/.env | cut -d'=' -f2)
    else
        ui_stop_spinner
        ui_status "error" "Kh√¥ng t√¨m th·∫•y N8N database password"
        return 1
    fi

    # Create user based on access mode
    local db_user
    local sql_commands

    if [[ "$access_mode" == "readonly" ]]; then
        db_user="nocodb_readonly"
        sql_commands="
            -- Drop user if exists
            DROP USER IF EXISTS $db_user;
            
            -- Create readonly user
            CREATE USER $db_user WITH PASSWORD '$n8n_db_password';
            
            -- Grant connect permission
            GRANT CONNECT ON DATABASE n8n TO $db_user;
            
            -- Grant schema usage
            GRANT USAGE ON SCHEMA public TO $db_user;
            
            -- Grant SELECT on all tables
            GRANT SELECT ON ALL TABLES IN SCHEMA public TO $db_user;
            
            -- Grant SELECT on future tables
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO $db_user;
        "
    else
        db_user="nocodb_full"
        sql_commands="
            -- Drop user if exists
            DROP USER IF EXISTS $db_user;
            
            -- Create full access user
            CREATE USER $db_user WITH PASSWORD '$n8n_db_password';
            
            -- Grant all privileges
            GRANT ALL PRIVILEGES ON DATABASE n8n TO $db_user;
            GRANT ALL PRIVILEGES ON SCHEMA public TO $db_user;
            GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $db_user;
            GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $db_user;
            
            -- Grant for future objects
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO $db_user;
            ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO $db_user;
        "
    fi

    # Debug info
    ui_stop_spinner
    ui_status "info" "ƒêang t·∫°o database user: $db_user"

    # Create temp SQL file to avoid escaping issues
    local temp_sql="/tmp/nocodb_setup_$.sql"
    echo "$sql_commands" > "$temp_sql"

    # Execute SQL commands with error output
    local error_log="/tmp/nocodb_db_error_$.log"
    if docker exec -i n8n-postgres psql -U n8n -d n8n < "$temp_sql" > "$error_log" 2>&1; then
        ui_status "success" "Database user $db_user ƒë√£ ƒë∆∞·ª£c t·∫°o"
        rm -f "$temp_sql" "$error_log"
    else
        ui_status "error" "Kh√¥ng th·ªÉ t·∫°o database user"
        echo "Chi ti·∫øt l·ªói:"
        cat "$error_log"
        rm -f "$temp_sql" "$error_log"
        return 1
    fi

    config_set "nocodb.db_user" "$db_user"
    config_set "nocodb.n8n_db_password" "$n8n_db_password"
    return 0
}

# ===== CREDENTIALS COLLECTION =====

collect_credentials() {
    ui_section "C·∫•u h√¨nh th√¥ng tin ƒëƒÉng nh·∫≠p"

    # Basic Auth credentials
    echo -e "${UI_CYAN}=== Basic Auth (Nginx) ===${UI_NC}"

    local auth_username
    echo -n -e "${UI_WHITE}Username (nocodb): ${UI_NC}"
    read -r auth_username
    auth_username=${auth_username:-nocodb}

    local auth_password
    while true; do
        echo -n -e "${UI_WHITE}Password (t·ªëi thi·ªÉu 8 k√Ω t·ª±): ${UI_NC}"
        read -s auth_password
        echo

        if [[ ${#auth_password} -ge 8 ]]; then
            break
        else
            ui_status "error" "Password ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±"
        fi
    done

    # NocoDB Admin credentials
    echo ""
    echo -e "${UI_CYAN}=== NocoDB Admin ===${UI_NC}"

    local domain=$(config_get "nocodb.domain")
    local admin_email
    echo -n -e "${UI_WHITE}Admin Email (admin@$domain): ${UI_NC}"
    read -r admin_email
    admin_email=${admin_email:-admin@$domain}

    # Validate email format
    while [[ ! "$admin_email" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; do
        ui_status "error" "Email kh√¥ng h·ª£p l·ªá"
        echo -n -e "${UI_WHITE}Admin Email: ${UI_NC}"
        read -r admin_email
    done

    local admin_password
    echo -n -e "${UI_WHITE}Admin Password (t·ªëi thi·ªÉu 8 k√Ω t·ª±): ${UI_NC}"
    read -s admin_password
    echo

    while [[ ${#admin_password} -lt 8 ]]; do
        ui_status "error" "Password ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±"
        echo -n -e "${UI_WHITE}Admin Password: ${UI_NC}"
        read -s admin_password
        echo
    done

    # Save credentials
    config_set "nocodb.auth_username" "$auth_username"
    config_set "nocodb.auth_password" "$auth_password"
    config_set "nocodb.admin_email" "$admin_email"
    config_set "nocodb.admin_password" "$admin_password"

    ui_status "success" "Th√¥ng tin ƒëƒÉng nh·∫≠p ƒë√£ ƒë∆∞·ª£c l∆∞u"
}

create_basic_auth() {
    local username=$(config_get "nocodb.auth_username")
    local password=$(config_get "nocodb.auth_password")

    # Install htpasswd if needed
    if ! command_exists htpasswd; then
        ui_run_command "C√†i ƒë·∫∑t apache2-utils" "apt-get update && apt-get install -y apache2-utils"
    fi

    # Create htpasswd file
    local htpasswd_file="/etc/nginx/.htpasswd-nocodb"
    sudo rm -f "$htpasswd_file"

    echo "$password" | sudo htpasswd -ci "$htpasswd_file" "$username"
    sudo chown www-data:www-data "$htpasswd_file"
    sudo chmod 644 "$htpasswd_file"

    ui_status "success" "Basic auth t·∫°o th√†nh c√¥ng"
}

# ===== DOCKER CONFIGURATION =====

create_directories() {
    ui_run_command "T·∫°o th∆∞ m·ª•c" "
        mkdir -p $NOCODB_DIR $BACKUP_DIR
        chmod 755 $NOCODB_DIR $BACKUP_DIR
    "
}

create_docker_config() {
    ui_start_spinner "T·∫°o NocoDB config"

    local domain=$(config_get "nocodb.domain")
    local port=$(config_get "nocodb.port")
    local db_user=$(config_get "nocodb.db_user")
    local n8n_db_password=$(config_get "nocodb.n8n_db_password")
    local admin_email=$(config_get "nocodb.admin_email")
    local admin_password=$(config_get "nocodb.admin_password")
    local access_mode=$(config_get "nocodb.access_mode")
    local jwt_secret=$(generate_random_string 64)

    # Add readonly flag if in readonly mode
    local readonly_env=""
    if [[ "$access_mode" == "readonly" ]]; then
        readonly_env="- NC_DISABLE_AUDIT=true"
    fi

    cat >"$NOCODB_DIR/docker-compose.yml" <<EOF
services:
  nocodb:
    image: nocodb/nocodb:latest
    container_name: nocodb
    restart: unless-stopped
    network_mode: host
    environment:
      - NC_DB=pg://localhost:5432?u=$db_user&p=$n8n_db_password&d=n8n
      - NC_PUBLIC_URL=https://$domain/nocodb
      - NC_ADMIN_EMAIL=$admin_email
      - NC_ADMIN_PASSWORD=$admin_password
      - NC_JWT_EXPIRES_IN=4h
      - NC_JWT_SECRET=$jwt_secret
      - NC_DISABLE_TELE=true
      - NC_SECURE_ATTACHMENTS=true
      - NC_PORT=8080
      $readonly_env
    volumes:
      - nocodb_data:/usr/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

volumes:
  nocodb_data:
EOF

    ui_stop_spinner
    ui_status "success" "Docker config t·∫°o th√†nh c√¥ng"
}

# ===== NGINX CONFIGURATION =====

configure_nginx() {
    local domain=$(config_get "nocodb.domain")
    local port=$(config_get "nocodb.port")
    local nginx_conf="/etc/nginx/sites-available/${domain}.conf"

    ui_start_spinner "C·∫•u h√¨nh Nginx"

    if [[ ! -f "$nginx_conf" ]]; then
        ui_stop_spinner
        ui_status "error" "Nginx config kh√¥ng t·ªìn t·∫°i: $nginx_conf"
        return 1
    fi

    # Backup
    sudo cp "$nginx_conf" "${nginx_conf}.backup.$(date +%Y%m%d_%H%M%S)"

    # Check if already configured
    if sudo grep -q "location /nocodb" "$nginx_conf"; then
        ui_stop_spinner
        ui_status "warning" "NocoDB ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh"
        return 0
    fi

    # Add NocoDB configuration
    sudo sed -i '/location ~ \/\\./i\
    # NocoDB subdirectory\
    location /nocodb/ {\
        auth_basic "N8N Database Access";\
        auth_basic_user_file /etc/nginx/.htpasswd-nocodb;\
        \
        proxy_pass http://127.0.0.1:'$port'/;\
        proxy_set_header Host $host;\
        proxy_set_header X-Real-IP $remote_addr;\
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\
        proxy_set_header X-Forwarded-Proto $scheme;\
        proxy_set_header X-Script-Name /nocodb;\
        \
        proxy_http_version 1.1;\
        proxy_set_header Upgrade $http_upgrade;\
        proxy_set_header Connection "upgrade";\
        \
        proxy_redirect ~^/(.*)$ /nocodb/$1;\
        proxy_redirect / /nocodb/;\
        \
        client_max_body_size 50M;\
        proxy_read_timeout 300s;\
    }\
' "$nginx_conf"

    # Test and reload nginx
    if sudo nginx -t; then
        sudo systemctl reload nginx
        ui_stop_spinner
        ui_status "success" "Nginx c·∫•u h√¨nh th√†nh c√¥ng"
        return 0
    else
        ui_stop_spinner
        ui_status "error" "Nginx validation th·∫•t b·∫°i"
        return 1
    fi
}

start_services() {
    ui_start_spinner "Kh·ªüi ƒë·ªông services"

    cd "$NOCODB_DIR"
    if ! docker compose up -d; then
        ui_stop_spinner
        return 1
    fi

    # Wait for health check
    local port=$(config_get "nocodb.port")
    local max_wait=60
    local waited=0

    while [[ $waited -lt $max_wait ]]; do
        if curl -s "http://localhost:$port/api/v1/health" >/dev/null 2>&1; then
            ui_stop_spinner
            ui_status "success" "Services kh·ªüi ƒë·ªông th√†nh c√¥ng"
            return 0
        fi
        sleep 2
        ((waited += 2))
    done

    ui_stop_spinner
    ui_status "error" "Services kh√¥ng kh·ªüi ƒë·ªông (timeout)"
    return 1
}

# ===== MANAGEMENT FUNCTIONS =====

get_nocodb_status() {
    if docker ps --format '{{.Names}}' | grep -q "^nocodb$"; then
        echo -e "${UI_GREEN}üü¢ Running${UI_NC}"
    else
        echo -e "${UI_RED}üî¥ Stopped${UI_NC}"
    fi
}

show_access_info() {
    local domain=$(config_get "nocodb.domain")
    local auth_user=$(config_get "nocodb.auth_username")
    local auth_pass=$(config_get "nocodb.auth_password")
    local admin_email=$(config_get "nocodb.admin_email")
    local admin_pass=$(config_get "nocodb.admin_password")
    local access_mode=$(config_get "nocodb.access_mode")

    ui_info_box "Th√¥ng tin truy c·∫≠p NocoDB" \
        "URL: https://$domain/nocodb" \
        "Ch·∫ø ƒë·ªô: $([ "$access_mode" == "readonly" ] && echo "CH·ªà XEM" || echo "ƒê·∫¶Y ƒê·ª¶")" \
        "" \
        "Basic Auth (Nginx):" \
        "Username: $auth_user" \
        "Password: $auth_pass" \
        "" \
        "NocoDB Admin:" \
        "Email: $admin_email" \
        "Password: $admin_pass"
}

manage_access_permissions() {
    ui_section "Qu·∫£n l√Ω quy·ªÅn truy c·∫≠p"

    local current_mode=$(config_get "nocodb.access_mode")
    echo "Ch·∫ø ƒë·ªô hi·ªán t·∫°i: $([ "$current_mode" == "readonly" ] && echo "CH·ªà XEM" || echo "ƒê·∫¶Y ƒê·ª¶")"
    echo ""

    echo "1) üîÑ Chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô truy c·∫≠p"
    echo "2) üîë ƒê·ªïi password Basic Auth"
    echo "3) üîê ƒê·ªïi password Admin NocoDB"
    echo "0) ‚¨ÖÔ∏è  Quay l·∫°i"
    echo ""

    echo -n -e "${UI_WHITE}Ch·ªçn [0-3]: ${UI_NC}"
    read -r choice

    case "$choice" in
    1) toggle_access_mode ;;
    2) change_basic_auth ;;
    3) change_admin_password ;;
    0) return ;;
    esac
}

toggle_access_mode() {
    local current_mode=$(config_get "nocodb.access_mode")
    local new_mode

    if [[ "$current_mode" == "readonly" ]]; then
        new_mode="full"
        ui_warning_box "‚ö†Ô∏è C·∫¢NH B√ÅO" \
            "Chuy·ªÉn sang ch·∫ø ƒë·ªô ƒê·∫¶Y ƒê·ª¶" \
            "Cho ph√©p CH·ªàNH S·ª¨A data N8N!"

        if ! ui_confirm "Ti·∫øp t·ª•c chuy·ªÉn sang ch·∫ø ƒë·ªô ƒë·∫ßy ƒë·ªß?"; then
            return
        fi
    else
        new_mode="readonly"
        ui_info_box "‚ÑπÔ∏è Th√¥ng b√°o" \
            "Chuy·ªÉn sang ch·∫ø ƒë·ªô CH·ªà XEM" \
            "An to√†n h∆°n cho data N8N"
    fi

    config_set "nocodb.access_mode" "$new_mode"

    # Reconfigure database access
    if setup_database_access; then
        # Restart NocoDB
        cd "$NOCODB_DIR"
        docker compose down
        create_docker_config
        docker compose up -d

        ui_status "success" "ƒê√£ chuy·ªÉn sang ch·∫ø ƒë·ªô $([ "$new_mode" == "readonly" ] && echo "CH·ªà XEM" || echo "ƒê·∫¶Y ƒê·ª¶")"
    else
        ui_status "error" "Kh√¥ng th·ªÉ chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô"
    fi
}

change_basic_auth() {
    echo -n "Username m·ªõi: "
    read -r new_username
    echo -n "Password m·ªõi: "
    read -s new_password
    echo

    if [[ ${#new_username} -lt 3 || ${#new_password} -lt 8 ]]; then
        ui_status "error" "Username >= 3, Password >= 8 k√Ω t·ª±"
        return
    fi

    # Update htpasswd
    echo "$new_password" | sudo htpasswd -ci /etc/nginx/.htpasswd-nocodb "$new_username"

    config_set "nocodb.auth_username" "$new_username"
    config_set "nocodb.auth_password" "$new_password"

    sudo systemctl reload nginx
    ui_status "success" "Basic Auth ƒë√£ c·∫≠p nh·∫≠t"
}

change_admin_password() {
    echo -n "Password m·ªõi cho admin: "
    read -s new_password
    echo

    if [[ ${#new_password} -lt 8 ]]; then
        ui_status "error" "Password ph·∫£i √≠t nh·∫•t 8 k√Ω t·ª±"
        return
    fi

    config_set "nocodb.admin_password" "$new_password"

    # Update container env
    cd "$NOCODB_DIR"
    docker compose down
    create_docker_config
    docker compose up -d

    ui_status "success" "Password ƒë√£ c·∫≠p nh·∫≠t"
}

# ===== N8N TABLES GUIDE =====

show_n8n_tables_guide() {
    ui_header "H∆∞·ªõng d·∫´n N8N Database Tables"

    ui_info_box "üìã B·∫£ng quan tr·ªçng" \
        "workflow_entity: L∆∞u tr·ªØ workflows" \
        "credentials_entity: Th√¥ng tin x√°c th·ª±c" \
        "execution_entity: L·ªãch s·ª≠ ch·∫°y workflows" \
        "webhook_entity: Webhooks ƒë√£ ƒëƒÉng k√Ω"

    echo ""
    echo -e "${UI_CYAN}=== C·∫£nh b√°o khi ch·ªânh s·ª≠a ===${UI_NC}"
    echo "‚ùå KH√îNG x√≥a ho·∫∑c s·ª≠a tr·ª±c ti·∫øp c√°c b·∫£ng sau:"
    echo "   - credentials_entity (m√£ h√≥a, s·ª≠a s·∫Ω h·ªèng)"
    echo "   - settings (c·∫•u h√¨nh h·ªá th·ªëng)"
    echo ""
    echo "‚ö†Ô∏è  C·∫®N TH·∫¨N khi s·ª≠a:"
    echo "   - workflow_entity (backup tr∆∞·ªõc khi s·ª≠a)"
    echo "   - execution_entity (c√≥ th·ªÉ x√≥a log c≈©)"
    echo ""
    echo "‚úÖ AN TO√ÄN ƒë·ªÉ xem:"
    echo "   - T·∫•t c·∫£ c√°c b·∫£ng ·ªü ch·∫ø ƒë·ªô SELECT"
    echo "   - Export data ƒë·ªÉ ph√¢n t√≠ch"
    echo ""

    read -p "Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c..."
}

# ===== BACKUP FUNCTIONS =====

backup_n8n_data() {
    ui_section "Backup N8N Data"

    local backup_name="n8n_backup_$(date +%Y%m%d_%H%M%S)"
    local backup_path="$BACKUP_DIR/$backup_name.sql"

    ui_start_spinner "ƒêang backup database..."

    # Create backup
    if docker exec n8n-postgres pg_dump -U n8n n8n > "$backup_path"; then
        ui_stop_spinner
        ui_status "success" "Backup th√†nh c√¥ng: $backup_path"

        # Compress
        if gzip "$backup_path"; then
            ui_status "success" "ƒê√£ n√©n: ${backup_path}.gz"
        fi
    else
        ui_stop_spinner
        ui_status "error" "Backup th·∫•t b·∫°i"
        return 1
    fi

    # Show recent backups
    echo ""
    echo "üìÅ Backups g·∫ßn ƒë√¢y:"
    ls -lh "$BACKUP_DIR"/*.gz 2>/dev/null | tail -5 || echo "Kh√¥ng c√≥ backup"
}

restart_nocodb() {
    ui_warning_box "Restart NocoDB" "Service s·∫Ω t·∫°m th·ªùi kh√¥ng kh·∫£ d·ª•ng"

    if ! ui_confirm "Ti·∫øp t·ª•c restart?"; then
        return
    fi

    ui_run_command "Restart NocoDB" "
        cd $NOCODB_DIR && docker compose restart
    "

    sleep 5
    local port=$(config_get "nocodb.port")
    if curl -s "http://localhost:$port/api/v1/health" >/dev/null 2>&1; then
        ui_status "success" "Restart th√†nh c√¥ng"
    else
        ui_status "error" "Restart th·∫•t b·∫°i"
    fi
}

show_logs() {
    echo "üìù NocoDB Logs:"
    echo "1) Application logs"
    echo "2) Error logs only"
    echo "3) Live logs (Ctrl+C ƒë·ªÉ tho√°t)"
    echo "0) Quay l·∫°i"
    echo ""

    echo -n -e "${UI_WHITE}Ch·ªçn [0-3]: ${UI_NC}"
    read -r choice

    case "$choice" in
    1) docker logs --tail 50 nocodb ;;
    2) docker logs nocodb 2>&1 | grep -i "error\|exception" || echo "No errors" ;;
    3) docker logs -f nocodb ;;
    0) return ;;
    esac
}

# ===== CLEANUP FUNCTIONS =====

cleanup_failed_installation() {
    ui_status "warning" "D·ªçn d·∫πp c√†i ƒë·∫∑t th·∫•t b·∫°i..."

    # Stop containers
    if [[ -f "$NOCODB_DIR/docker-compose.yml" ]]; then
        cd "$NOCODB_DIR" && docker compose down -v 2>/dev/null || true
    fi

    # Remove directories
    rm -rf "$NOCODB_DIR" 2>/dev/null || true

    # Restore nginx if needed
    local domain=$(config_get "nocodb.domain" "")
    if [[ -n "$domain" ]]; then
        local nginx_conf="/etc/nginx/sites-available/${domain}.conf"
        local backup=$(ls "${nginx_conf}.backup."* 2>/dev/null | tail -1)
        if [[ -f "$backup" ]]; then
            cp "$backup" "$nginx_conf"
            systemctl reload nginx 2>/dev/null || true
        fi
    fi

    rm -f /etc/nginx/.htpasswd-nocodb 2>/dev/null || true
}

uninstall_nocodb() {
    ui_warning_box "G·ª° c√†i ƒë·∫∑t NocoDB" \
        "‚ö†Ô∏è  S·∫Ω x√≥a to√†n b·ªô c·∫•u h√¨nh NocoDB" \
        "Data N8N s·∫Ω KH√îNG b·ªã ·∫£nh h∆∞·ªüng"

    echo -n "G√µ 'DELETE' ƒë·ªÉ x√°c nh·∫≠n: "
    read -r confirmation

    if [[ "$confirmation" != "DELETE" ]]; then
        ui_status "info" "ƒê√£ h·ªßy"
        return
    fi

    # Stop services
    if [[ -f "$NOCODB_DIR/docker-compose.yml" ]]; then
        ui_run_command "D·ª´ng services" "
            cd $NOCODB_DIR && docker compose down -v
        "
    fi

    # Deep cleanup
    ui_run_command "X√≥a containers v√† volumes" "
        # Remove any NocoDB related containers
        docker ps -a --format '{{.Names}}' | grep -E 'nocodb' | xargs -r docker rm -f 2>/dev/null || true
        
        # Remove all NocoDB volumes
        docker volume ls --format '{{.Name}}' | grep -E 'nocodb' | xargs -r docker volume rm 2>/dev/null || true
    "

    # Remove directories
    ui_run_command "X√≥a th∆∞ m·ª•c" "
        rm -rf $NOCODB_DIR /opt/nocodb-db /nocodb-cloud 2>/dev/null || true
    "

    # Drop database users
    if docker ps --format '{{.Names}}' | grep -q "n8n-postgres"; then
        ui_run_command "X√≥a database users" "
            docker exec n8n-postgres psql -U n8n -d n8n -c '
                DROP USER IF EXISTS nocodb_readonly CASCADE;
                DROP USER IF EXISTS nocodb_full CASCADE;
            ' 2>/dev/null || true
        "
    fi

    # Clean all nginx configs
    ui_run_command "D·ªçn d·∫πp Nginx configs" "
        # Find and clean all nginx configs with nocodb
        for conf in /etc/nginx/sites-available/*.conf; do
            if grep -q 'location /nocodb' \"\$conf\" 2>/dev/null; then
                # Backup
                cp \"\$conf\" \"\${conf}.pre-uninstall.\$(date +%Y%m%d_%H%M%S)\"
                # Remove nocodb block
                sed -i '/# NocoDB subdirectory/,/^$/d' \"\$conf\"
            fi
        done
        
        # Remove all htpasswd files
        rm -f /etc/nginx/.htpasswd-nocodb*
        
        # Reload nginx
        systemctl reload nginx || true
    "

    # Clean backup directory
    if [[ -d "$BACKUP_DIR" ]]; then
        ui_run_command "X√≥a backups" "rm -rf $BACKUP_DIR"
    fi

    # Clear all config
    ui_run_command "X√≥a c·∫•u h√¨nh" "
        # Clear all nocodb related configs
        for key in \$(grep '^nocodb\\.' ~/.config/datalonline-n8n/settings.conf 2>/dev/null | cut -d= -f1); do
            sed -i \"/^\$key=/d\" ~/.config/datalonline-n8n/settings.conf
        done
    "

    ui_status "success" "NocoDB ƒë√£ ƒë∆∞·ª£c g·ª° ho√†n to√†n"
}

# Export main function
export -f nocodb_main_menu